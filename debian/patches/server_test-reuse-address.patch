From: =?utf-8?q?Guido_G=C3=BCnther?= <agx@sigxcpu.org>
Date: Sat, 2 Jan 2016 18:42:21 +0100
Subject: server_test: reuse address

to avoid test failures when tests get run quickly after each other

(as with e.g. runtests.sh)
---
 nspr/pr/tests/server_test.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/nspr/pr/tests/server_test.c b/nspr/pr/tests/server_test.c
index 904594e..9cb6660 100644
--- a/nspr/pr/tests/server_test.c
+++ b/nspr/pr/tests/server_test.c
@@ -248,6 +248,7 @@ PRFileDesc *
 ServerSetup(void)
 {
     PRFileDesc *listenSocket;
+    PRSocketOptionData sockOpt;
     PRNetAddr serverAddr;
     PRThread *WorkerThread;
 
@@ -257,6 +258,16 @@ ServerSetup(void)
         return NULL;
     }
 
+    sockOpt.option = PR_SockOpt_Reuseaddr;
+    sockOpt.value.reuse_addr = PR_TRUE;
+    if ( PR_SetSocketOption(listenSocket, &sockOpt) == PR_FAILURE) {
+      if (debug_mode) printf("\tServer error setting socket option: OS error %d\n",
+                             PR_GetOSError());
+      else Test_Result(FAIL);
+      PR_Close(listenSocket);
+      return NULL;
+    }
+
     memset(&serverAddr, 0, sizeof(PRNetAddr));
     serverAddr.inet.family = PR_AF_INET;
     serverAddr.inet.port = PR_htons(PORT);
